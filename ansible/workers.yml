---
- hosts:
  - worker_rhel6
  - worker_rhel7
  - worker_fedora

  become: yes
  become_method: sudo

  tasks:
  - name: Set up Jenkins user
    user:
      name: jenkins
      comment: "Jenkins user"

  # we use the public key to connect to slaves from jenkins master
  - name: Authorize master's jenkins user public key
    authorized_key:
      user: jenkins
      key: "{{ lookup('file', 'generated_bits/master_id_rsa.pub') }}"
      exclusive: yes  # only need one key for "jenkins" user, users can still connect as ec2-user
      state: present

  # RHEL6 optional RPMs are required for -devel packages
  # we can't use yum_repository ansible module because it doesn't allow
  # modification of existing repo files, it's mainly for creating new files
  - name: Enable the RHEL6 server optional RPMs repo
    ini_file:
      path: /etc/yum.repos.d/redhat-rhui.repo
      section: rhui-REGION-rhel-server-releases-optional
      option: enabled
      value: yes
      create: no
      state: present
    when: ansible_distribution == 'RedHat' and ansible_distribution_version.split(".")[0] == "6"

  # RHEL7 optional RPMs are required for -devel packages
  # we can't use yum_repository ansible module because it doesn't allow
  # modification of existing repo files, it's mainly for creating new files
  - name: Enable the RHEL7 server optional RPMs repo
    ini_file:
      path: /etc/yum.repos.d/redhat-rhui.repo
      section: rhui-REGION-rhel-server-optional
      option: enabled
      value: yes
      create: no
      state: present
    when: ansible_distribution == 'RedHat' and ansible_distribution_version.split(".")[0] == "7"

  - name: Ensure general Jenkins dependencies are installed
    package:
      name:
        - java

  - name: Ensure general build dependencies are installed
    package:
      name:
        - autoconf
        - automake
        - libtool
        - doxygen
        - git
        - rubygems
        - gawk

  - name: Ensure OpenSCAP dependencies are installed
    package:
      name:
      - dbus-devel
      - libacl-devel
      - libblkid-devel
      - libcap-devel
      - libcurl-devel
      - libgcrypt-devel
      - libselinux-devel
      - libxml2-devel
      - libxslt-devel
      - make
      - openldap-devel
      - pcre-devel
      - perl-XML-Parser
      - perl-XML-XPath
      - perl-devel
      - python-devel
      - rpm-devel
      - swig
      - bzip2-devel
      - GConf2-devel
      - sendmail  # the openscap OVAL mitre requires sendmail to complete
      state: installed

  - name: Ensure OpenSCAP dependencies are running
    service:
      name: sendmail
      enabled: yes
      state: started

  - name: Ensure SCAP Workbench dependencies are installed
    package:
      name:
      - cmake
      - gcc-c++
      - openssh-clients
      - util-linux
      - openscap-devel
      - qt-devel
      - polkit
      state: installed

  - name: Ensure SCAP Workbench has asciidoctor installed
    gem:
      name: asciidoctor
      user_install: no # let's install it everywhere

  - name: Ensure SCAP Security Guide dependencies are installed
    package:
      name:
      - cmake
      - openscap-utils
      - git
      state: installed

  - name: Ensure OpenSCAP Daemon dependencies are installed
    package:
      name:
      - dbus-python
      - gobject-introspection
      - pygobject2-devel
#      - pygobject3-devel
#      - python3-dbus
#      - python3-gobject-base
      state: installed
    when: ansible_distribution != 'RedHat' or ansible_distribution_version.split(".")[0] >= "7"
